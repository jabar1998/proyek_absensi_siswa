<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Aplikasi Absensi Siswa</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    body {
      background-color: #f8f9fa; /* Latar belakang abu-abu lembut */
    }
    .spinner-border {
      display: none;
    }
    /* Pusatkan panel login */
    #login-container {
      min-height: 90vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    /* Layout utama setelah login */
    #main-layout {
      display: none; /* Sembunyikan sampai login berhasil */
    }
    .sidebar {
      height: 100vh;
      position: sticky;
      top: 0;
      background-color: #fff;
      padding-top: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    /* Sembunyikan sidebar di layar kecil */
    @media (max-width: 991.98px) {
      .sidebar {
        display: none;
      }
      #main-content {
        padding-top: 1rem; /* <-- PERUBAHAN DI SINI */
      }
    }
    /* Tampilkan navbar hanya di layar kecil */
    .mobile-nav {
      display: none;
    }
    @media (max-width: 991.98px) {
      .mobile-nav {
        display: block;
        position: sticky;
        top: 0;
        z-index: 1020;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
    }
    .nav-link.active {
      background-color: #e9ecef;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <div id="login-container">
    <div id="login-panel" class="card mb-3 shadow-sm" style="max-width:480px; width:100%;">
      <div class="card-body p-4">
        <h3 class="card-title text-center mb-4">Aplikasi Absensi Siswa</h3>
        <div class="mb-3">
          <label class="form-label">Username</label>
          <input type="text" id="login-username" class="form-control" placeholder="username">
        </div>
        <div class="mb-3">
          <label class="form-label">Password</label>
          <input type="password" id="login-password" class="form-control" placeholder="password">
        </div>
        <div class="d-grid">
          <button id="login-btn" class="btn btn-primary">Masuk</button>
        </div>
        <div id="login-msg" class="text-danger mt-2"></div>
      </div>
    </div>
  </div>

  <div id="main-layout">
    <nav class="navbar navbar-expand-lg navbar-light bg-light mobile-nav">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Absensi Siswa</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mobileNavbar">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="mobileNavbar">
          <ul id="mobile-nav-links" class="navbar-nav me-auto mb-2 mb-lg-0">
            </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <nav id="main-nav" class="col-lg-2 d-lg-block sidebar">
          <h4 class="px-3 mb-3">Menu</h4>
          <div id="nav-links" class="nav flex-column nav-pills">
            </div>
        </nav>

        <main class="col-lg-10" id="main-content">
          <div class="p-3">
            <h2 id="page-title" class="mb-3">Dashboard</h2>
            <div id="welcome" class="mb-3 alert alert-info"></div>
            
            <div id="content">
              <div class="text-center p-5">
                <div class="spinner-border" role="status" style="width: 3rem; height: 3rem;">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
              <div id="page-content">
                <p class="text-muted">Silakan login untuk memulai.</p>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>
  </div>

  <script>
    // ====== SESSION (Browser) ======
    let TOKEN = '';
    let ROLE  = '';
    let KELAS = '';

    function saveSession(obj){
      localStorage.setItem('abs_sess', JSON.stringify(obj||{}));
    }
    function loadSession(){
      try{ return JSON.parse(localStorage.getItem('abs_sess')||'{}'); }catch(e){ return {}; }
    }
    function clearSession(){
      localStorage.removeItem('abs_sess');
      TOKEN=''; ROLE=''; KELAS='';
    }

    // ========== LOADER HALAMAN ==========
    function runInitializer(pageName){
      try {
        if (window.Initializers && typeof Initializers[pageName] === 'function') {
          Initializers[pageName]();
        }
      } catch (e) {
        console.error('Initializer error:', e);
        const pc = document.getElementById('page-content');
        if (pc) pc.insertAdjacentHTML('afterbegin',
          `<div class="alert alert-danger">Gagal inisialisasi halaman ${pageName}: ${e.message}</div>`);
      }
    }
    
    // Fungsi baru untuk menandai link menu yang aktif
    function setActiveLink(pageName) {
      document.querySelectorAll('#nav-links .nav-link, #mobile-nav-links .nav-link').forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('data-page') === pageName) {
          link.classList.add('active');
        }
      });
      // Update judul halaman
      const activeLink = document.querySelector(`.nav-link[data-page="${pageName}"]`);
      if (activeLink) {
        document.getElementById('page-title').textContent = activeLink.textContent;
      }
    }

    function loadPage(pageName) {
      const pc = document.getElementById('page-content');
      pc.innerHTML = '';
      document.querySelector('.spinner-border').style.display = 'block';

      // Tutup navbar mobile setelah link diklik
      const mobileNavbar = document.getElementById('mobileNavbar');
      if (mobileNavbar.classList.contains('show')) {
          new bootstrap.Collapse(mobileNavbar).hide();
      }

      google.script.run
        .withSuccessHandler(function(html) {
          pc.innerHTML = html;
          document.querySelector('.spinner-border').style.display = 'none';
          setActiveLink(pageName);
          runInitializer(pageName);
        })
        .withFailureHandler(function(error) {
          pc.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
          document.querySelector('.spinner-border').style.display = 'none';
        })
        .loadPageContent(pageName, TOKEN);
    }

    window.onerror = function (msg, url, line, col) {
      console.error('JS Error', msg, url, line, col);
      const box = document.createElement('div');
      box.className = 'alert alert-danger m-3';
      box.style.position = 'fixed'; box.style.right = '12px'; box.style.bottom = '12px';
      box.style.zIndex = 9999; box.style.maxWidth = '520px';
      box.innerHTML = `<strong>JavaScript Error</strong><br>${msg}<br><small>${url}:${line}:${col}</small>`;
      document.body.appendChild(box);
      return false;
    };

    // ====== MENU (DIMODIFIKASI) ======
    function renderMenu(){
      const navDesktop = document.getElementById('nav-links');
      const navMobile = document.getElementById('mobile-nav-links');
      if (!navDesktop || !navMobile) return;
      
      navDesktop.innerHTML = '';
      navMobile.innerHTML = '';

      const itemsTU = [
        ['Dashboard Utama','Dashboard'], ['Input Absensi Harian','FormAbsensi'], ['Laporan Harian','LaporanHarian'],
        ['Laporan Bulanan','LaporanBulanan'], ['Laporan Pelanggaran','Pelanggaran'], ['Data Siswa','DataSiswa'],
        ['Edit Kehadiran','EditKehadiran'], ['Pengaturan','Pengaturan'], ['Keluar','__LOGOUT__']
      ];
      const itemsWali = [
        ['Dashboard Kelas','Dashboard'], ['Laporan Harian','LaporanHarian'], ['Laporan Bulanan','LaporanBulanan'],
        ['Laporan Pelanggaran','Pelanggaran'], ['Keluar','__LOGOUT__']
      ];
      const items = (ROLE === 'TU') ? itemsTU : itemsWali;

      items.forEach(([label, page])=>{
        // Membuat link untuk sidebar desktop
        const aDesktop = document.createElement('a');
        aDesktop.href = '#';
        aDesktop.className = 'nav-link mb-1' + (page==='__LOGOUT__' ? ' text-danger' : '');
        aDesktop.textContent = label;
        aDesktop.dataset.page = page; // atribut data untuk identifikasi
        aDesktop.onclick = (e)=>{ e.preventDefault(); if (page==='__LOGOUT__') logoutApp(); else loadPage(page); };
        navDesktop.appendChild(aDesktop);

        // Membuat link untuk navbar mobile
        const liMobile = document.createElement('li');
        liMobile.className = 'nav-item';
        const aMobile = document.createElement('a');
        aMobile.href = '#';
        aMobile.className = 'nav-link' + (page==='__LOGOUT__' ? ' text-danger' : '');
        aMobile.textContent = label;
        aMobile.dataset.page = page;
        aMobile.onclick = (e)=>{ e.preventDefault(); if (page==='__LOGOUT__') logoutApp(); else loadPage(page); };
        liMobile.appendChild(aMobile);
        navMobile.appendChild(liMobile);
      });
    }

    function logoutApp() {
      clearSession();
      
      // Toggle UI
      document.getElementById('login-container').style.display = 'flex';
      document.getElementById('main-layout').style.display = 'none';
      document.getElementById('login-username').value = '';
      document.getElementById('login-password').value = '';

      try {
        google.script.run.logoutToken(TOKEN);
      } catch (e) { /* abaikan error */ }
      
      TOKEN = ''; ROLE = ''; KELAS = '';
    }

    function showMainApp(sessionData) {
        TOKEN = sessionData.token;
        ROLE = sessionData.role || '';
        KELAS = sessionData.kelas || '';

        document.getElementById('login-container').style.display = 'none';
        document.getElementById('main-layout').style.display = 'block';

        const welcomeEl = document.getElementById('welcome');
        if (welcomeEl) {
            welcomeEl.innerHTML = `Selamat datang kembali, <strong>${sessionData.username||''}</strong> — Peran: <strong>${ROLE}</strong>${ROLE==='Wali Kelas'&&KELAS?' (Kelas: <strong>'+KELAS+'</strong>)':''}`;
        }
        renderMenu();
        loadPage('Dashboard');
    }

    // ====== LOGIN UI (DIMODIFIKASI) ======
    document.addEventListener('DOMContentLoaded', ()=>{
      const sess = loadSession();
      if (sess && sess.token){
        showMainApp(sess);
      } else {
        document.getElementById('login-container').style.display = 'flex';
        document.getElementById('main-layout').style.display = 'none';
      }

      const btn = document.getElementById('login-btn');
      if (btn) btn.addEventListener('click', ()=>{
        const u = (document.getElementById('login-username').value||'').trim();
        const p = (document.getElementById('login-password').value||'');
        const msg = document.getElementById('login-msg');
        msg.textContent = '';
        btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Memeriksa...';

        google.script.run
          .withSuccessHandler(res=>{
            btn.disabled=false; btn.textContent='Masuk';
            const sessionData = { token:res.token, role:res.role, kelas:res.kelas, username:res.username };
            saveSession(sessionData);
            showMainApp(sessionData);
          })
          .withFailureHandler(err=>{
            btn.disabled=false; btn.textContent='Masuk';
            msg.textContent = String(err);
          })
          .loginUser({ username:u, password:p });
      });
    });

    // ====== INITIALIZERS HALAMAN (Tidak ada perubahan di sini, tetap sama) ======
    // ... (Semua kode Initializers Anda dari Initializers.Dashboard sampai Initializers.DataSiswa tetap sama) ...
    // ... (Salin dan tempel semua Initializer Anda di sini) ...
    window.Initializers = window.Initializers || {};

     // DASHBOARD
     let trendChart;
     Initializers.Dashboard = function() {
       const kelasParam = (ROLE === 'Wali Kelas') ? KELAS : 'Semua';
       google.script.run
         .withSuccessHandler(updateDashboardUI)
         .withFailureHandler(err => {
           document.getElementById('page-content')
             .insertAdjacentHTML('afterbegin', `<div class="alert alert-warning mb-3">Gagal memuat ringkasan: ${String(err)}</div>`);
         })
         .getDashboardData(kelasParam, TOKEN);

       google.script.run.withSuccessHandler(renderTrendChart).getTrend30Hari(kelasParam, TOKEN);
     };
     function updateDashboardUI(data) {
       const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
       set('alfa-today',  (data.today?.Alfa)||0);
       set('izin-today',  (data.today?.Izin)||0);
       set('sakit-today', (data.today?.Sakit)||0);
       set('alfa-month',  (data.thisMonth?.Alfa)||0);
       set('izin-month',  (data.thisMonth?.Izin)||0);
       set('sakit-month', (data.thisMonth?.Sakit)||0);

       const list = (id, items, fmt) => {
         const ul = document.getElementById(id); if (!ul) return;
         ul.innerHTML = '';
         if (items?.length) {
           items.forEach(it=>{
             const li = document.createElement('li');
             li.className='list-group-item d-flex justify-content-between align-items-center';
             li.innerHTML = `${fmt(it)} <span class="badge bg-primary rounded-pill">${it.total}</span>`;
             ul.appendChild(li);
           });
         } else {
           ul.innerHTML = '<li class="list-group-item">Tidak ada data</li>';
         }
       };
       list('kelas-terbanyak', data.topKelas, it=>it.kelas);
       list('siswa-terbanyak', data.topSiswa, it=>`${it.nama} (${it.kelas})`);
     }
     function renderTrendChart(rows){
       const ctx = document.getElementById('trend-canvas'); if (!ctx) return;
       const labels = rows.map(r=>r.tanggal);
       const alfa = rows.map(r=>r.Alfa), izin = rows.map(r=>r.Izin), sakit = rows.map(r=>r.Sakit);
       if (trendChart) trendChart.destroy();
       trendChart = new Chart(ctx, {
         type: 'line',
         data: { labels, datasets: [{label:'Alfa',data:alfa},{label:'Izin',data:izin},{label:'Sakit',data:sakit}] },
         options: { responsive:true, maintainAspectRatio:false }
       });
     }

     // FORM ABSENSI
     Initializers.FormAbsensi = function() {
       const tgl = document.getElementById('tanggal'); if (tgl) tgl.valueAsDate = new Date();
       google.script.run.withSuccessHandler(populateKelasDropdown).withFailureHandler(e=>alert(String(e))).getDaftarKelas(TOKEN);
       const form  = document.getElementById('absensi-form');
       const kelas = document.getElementById('kelas');
       if (form)  form.addEventListener('submit', handleFormSubmit);
       if (kelas) kelas.addEventListener('change', handleKelasChange);
     };
     function populateKelasDropdown(kelasArray) {
       const sel = document.getElementById('kelas'); if (!sel) return;
       sel.innerHTML = '<option selected disabled value="">Pilih salah satu...</option>';
       (kelasArray||[]).forEach(k=> k && sel.add(new Option(k,k)));
     }
     function handleKelasChange(e){
       const kelas = e.target.value;
       const siswaSelect = document.getElementById('siswa');
       siswaSelect.disabled = true; siswaSelect.innerHTML = '<option>Memuat siswa...</option>';
       google.script.run.withSuccessHandler(populateSiswaDropdown).withFailureHandler(err=>{
         siswaSelect.innerHTML='<option disabled>Gagal memuat siswa</option>'; alert(String(err));
       }).getSiswaByKelas(kelas, TOKEN);
     }
     function populateSiswaDropdown(siswaArray){
       const sel = document.getElementById('siswa'); if (!sel) return;
       sel.innerHTML = '<option selected disabled value="">Pilih salah satu...</option>';
       (siswaArray||[]).forEach(([nisn,nama]) => sel.add(new Option(`${nama} (${nisn})`, `${nisn}|${nama}`))); sel.disabled=false;
     }
     function handleFormSubmit(ev){
       ev.preventDefault();
       const form=ev.target, msg=document.getElementById('status-message');
       msg.innerHTML='<div class="alert alert-info">Menyimpan data...</div>';
       const [nisnSiswa,namaSiswa]=(form.querySelector('#siswa').value||'').split('|');
       const payload={
         tanggal:form.querySelector('#tanggal').value, kelas:form.querySelector('#kelas').value,
         nisn_siswa:nisnSiswa, nama_siswa:namaSiswa,
         status:form.querySelector('input[name="status"]:checked').value,
         keterangan:form.querySelector('#keterangan').value
       };
       google.script.run.withSuccessHandler(txt=>{
         msg.innerHTML=`<div class="alert alert-success">${txt}</div>`; form.reset(); const t=document.getElementById('tanggal'); if (t) t.valueAsDate=new Date();
       }).withFailureHandler(err=>{ msg.innerHTML=`<div class="alert alert-danger">Error: ${String(err)}</div>`; }).simpanAbsensi(payload, TOKEN);
     }

     // LAPORAN HARIAN
     Initializers.LaporanHarian = function () {
       const t = document.getElementById('lap-tanggal');
       if (t) t.valueAsDate = new Date();

       google.script.run
         .withSuccessHandler(arr => {
           const sel = document.getElementById('lap-kelas');
           if (!sel) return;
           sel.innerHTML = '';
           sel.add(new Option('Semua','Semua'));
           (arr || []).forEach(k => sel.add(new Option(k, k)));
           if (ROLE === 'Wali Kelas' && KELAS) sel.value = KELAS;
         })
         .getDaftarKelas(TOKEN);

       document.getElementById('btn-tampilkan').addEventListener('click', () => {
         const tanggal = document.getElementById('lap-tanggal').value;
         let kelas = document.getElementById('lap-kelas').value;
         if (ROLE === 'Wali Kelas' && KELAS) kelas = KELAS;

         const wrap = document.getElementById('laporan-wrap');
         wrap.innerHTML = '<div class="alert alert-info">Memuat laporan...</div>';

         google.script.run
           .withSuccessHandler(renderLaporanHarian)
           .withFailureHandler(err => wrap.innerHTML = `<div class="alert alert-danger">${String(err)}</div>`)
           .getLaporanHarian({ tanggal, kelas }, TOKEN);
       });

       const btnPDF = document.getElementById('btn-export-sheet');
       if (btnPDF) btnPDF.addEventListener('click', () => {
         const tanggal = document.getElementById('lap-tanggal').value;
         let kelas = document.getElementById('lap-kelas').value;
         if (ROLE === 'Wali Kelas' && KELAS) kelas = KELAS;

         btnPDF.disabled = true; btnPDF.textContent = 'Membuat PDF...';
         google.script.run
           .withSuccessHandler(url => { btnPDF.disabled = false; btnPDF.textContent = 'Cetak (Template PDF)'; window.open(url, '_blank'); })
           .withFailureHandler(err => { btnPDF.disabled = false; btnPDF.textContent = 'Cetak (Template PDF)'; alert(String(err)); })
           .exportLaporanHarianPDF({ tanggal, kelas }, TOKEN);
       });
     };
     function renderLaporanHarian(rep){
       const sum = `
         <div class="row g-3">
           <div class="col-md-3"><div class="card"><div class="card-body"><strong>Tanggal</strong><div>${rep.tanggal}</div></div></div></div>
           <div class="col-md-3"><div class="card"><div class="card-body"><strong>Kelas</strong><div>${rep.kelas || 'Semua'}</div></div></div></div>
           <div class="col-md-2"><div class="card border-danger"><div class="card-body"><strong>Alfa</strong><div>${rep.counts.Alfa}</div></div></div></div>
           <div class="col-md-2"><div class="card border-warning"><div class="card-body"><strong>Izin</strong><div>${rep.counts.Izin}</div></div></div></div>
           <div class="col-md-2"><div class="card border-info"><div class="card-body"><strong>Sakit</strong><div>${rep.counts.Sakit}</div></div></div></div>
         </div>`;
       const rows = (rep.rows?.length ? rep.rows.map((r,i)=>`
         <tr>
           <td>${i+1}</td><td>${r.nisn || ''}</td><td>${r.nama || ''}</td>
           <td>${r.kelas || ''}</td><td>${r.status || ''}</td><td>${r.keterangan || ''}</td><td>${r.petugas || ''}</td>
         </tr>`).join('') : `<tr><td colspan="7" class="text-center text-muted">Tidak ada data</td></tr>`);
       const tbl = `
         <div class="table-responsive mt-3">
           <table class="table table-bordered align-middle">
             <thead class="table-light"><tr><th>#</th><th>NISN</th><th>Nama</th><th>Kelas</th><th>Status</th><th>Keterangan</th><th>Petugas</th></tr></thead>
             <tbody>${rows}</tbody>
           </table>
         </div>`;
       document.getElementById('laporan-wrap').innerHTML = sum + tbl;
     }

     // LAPORAN BULANAN (paged + export)
     Initializers.LaporanBulanan = function () {
       let nextOffset = 0;

       const now = new Date();
       const elBln  = document.getElementById('lb-bulan');
       const elThn  = document.getElementById('lb-tahun');
       const elKls  = document.getElementById('lb-kelas');
       const elNisn = document.getElementById('lb-nisn');
       const area   = document.getElementById('lb-wrap');

       if (!elBln || !elThn || !elKls || !area) {
         alert('Elemen Laporan Bulanan tidak ditemukan. Pastikan id di LaporanBulanan.html sudah sesuai.');
         return;
       }

       elBln.value = now.getMonth() + 1;
       elThn.value = now.getFullYear();

       google.script.run
         .withSuccessHandler(arr => {
           elKls.innerHTML = '';
           elKls.add(new Option('Semua', 'Semua'));
           (arr || []).forEach(k => elKls.add(new Option(k, k)));
           if (ROLE === 'Wali Kelas' && KELAS) elKls.value = KELAS;
         })
         .getDaftarKelas(TOKEN);

       document.getElementById('lb-tampilkan').addEventListener('click', () => load(false));

       const btnRekap = document.getElementById('lb-export-rekap');
       if (btnRekap) btnRekap.addEventListener('click', ()=>{
         const bulan = Number(elBln.value);
         const tahun = Number(elThn.value);
         let kelas   = elKls.value;
         if (ROLE === 'Wali Kelas' && KELAS) kelas = KELAS;

         btnRekap.disabled = true; btnRekap.textContent = 'Membuat PDF...';
         google.script.run
           .withSuccessHandler(url => { btnRekap.disabled=false; btnRekap.textContent='Cetak Rekap (Template PDF)'; window.open(url, '_blank'); })
           .withFailureHandler(err => { btnRekap.disabled=false; btnRekap.textContent='Cetak Rekap (Template PDF)'; alert(String(err)); })
           .exportLaporanBulananRekapPDF({ bulan, tahun, kelas }, TOKEN);
       });

       const btnBulk = document.getElementById('lb-export-bulk');
       if (btnBulk) btnBulk.addEventListener('click', ()=>{
         const bulan = Number(elBln.value);
         const tahun = Number(elThn.value);
         let kelas   = elKls.value;
         if (ROLE === 'Wali Kelas' && KELAS) kelas = KELAS;

         btnBulk.disabled = true; btnBulk.textContent = 'Membuat PDF...';
         google.script.run
           .withSuccessHandler(url => { btnBulk.disabled=false; btnBulk.textContent='Cetak per Siswa (Semua)'; window.open(url, '_blank'); })
           .withFailureHandler(err => { btnBulk.disabled=false; btnBulk.textContent='Cetak per Siswa (Semua)'; alert(String(err)); })
           .exportLaporanBulananPerSiswaAll({ bulan, tahun, kelas }, TOKEN);
       });

       function load(append) {
         const bulan = Number(elBln.value);
         const tahun = Number(elThn.value);
         let kelas   = elKls.value;
         if (ROLE === 'Wali Kelas' && KELAS) kelas = KELAS;
         const nisn  = (elNisn ? elNisn.value : '').trim();

         if (!append) { area.innerHTML = '<div class="alert alert-info">Memuat...</div>'; nextOffset = 0; }

         google.script.run
           .withSuccessHandler(rep => {
             const s = rep.summary;

             if (!append) {
               area.innerHTML = `
                 <div class="row g-3">
                   <div class="col-md-3"><div class="card"><div class="card-body"><strong>Bulan</strong><div>${rep.bulan}/${rep.tahun}</div></div></div></div>
                   <div class="col-md-3"><div class="card"><div class="card-body"><strong>Kelas</strong><div>${rep.kelas}</div></div></div></div>
                   <div class="col-md-2"><div class="card"><div class="card-body"><strong>Alfa</strong><div>${s.Alfa}</div></div></div></div>
                   <div class="col-md-2"><div class="card"><div class="card-body"><strong>Izin</strong><div>${s.Izin}</div></div></div></div>
                   <div class="col-md-2"><div class="card"><div class="card-body"><strong>Sakit</strong><div>${s.Sakit}</div></div></div></div>
                 </div>
                 <div class="table-responsive mt-3">
                   <table class="table table-bordered align-middle" id="lb-table">
                     <thead class="table-light">
                       <tr><th>#</th><th>NISN</th><th>Nama</th><th>Kelas</th><th>Tanggal</th><th>Status</th><th>Keterangan</th><th>Petugas</th><th>Aksi</th></tr>
                     </thead>
                     <tbody id="lb-tbody"></tbody>
                   </table>
                 </div>
                 <div id="lb-more" class="mt-2"></div>`;
             }

             const tbody = document.getElementById('lb-tbody');
             const startIndex = nextOffset;
             rep.rows.forEach((r, i) => {
               const tr = document.createElement('tr');
               tr.innerHTML = `<td>${startIndex + i + 1}</td>
                 <td>${r.nisn || ''}</td><td>${r.nama || ''}</td><td>${r.kelas || ''}</td>
                 <td>${r.tanggal || ''}</td>
                 <td>${r.status || ''}</td><td>${r.keterangan || ''}</td><td>${r.petugas || ''}</td>
                 <td><button class="btn btn-sm btn-outline-secondary" data-nisn="${r.nisn||''}">PDF</button></td>`;
               tbody.appendChild(tr);
             });

             // delegasi klik PDF per siswa
             tbody.onclick = function(e){
               const btn = e.target.closest('button[data-nisn]');
               if (!btn) return;
               const nisnSel = btn.getAttribute('data-nisn');
               const bulan = Number(elBln.value);
               const tahun = Number(elThn.value);
               let kelas   = elKls.value;
               if (ROLE === 'Wali Kelas' && KELAS) kelas = KELAS;

               const old = btn.textContent;
               btn.disabled = true; btn.textContent = '...';
               google.script.run
                 .withSuccessHandler(url => { btn.disabled=false; btn.textContent=old; window.open(url,'_blank'); })
                 .withFailureHandler(err => { btn.disabled=false; btn.textContent=old; alert(String(err)); })
                 .exportLaporanBulananPerSiswaOne({ bulan, tahun, kelas, nisn: nisnSel }, TOKEN);
             };

             const more = document.getElementById('lb-more');
             if (rep.truncated) {
               nextOffset = rep.nextOffset;
               more.innerHTML = `<button class="btn btn-outline-primary">Muat lagi (sisa ${rep.total - nextOffset})</button>`;
               more.querySelector('button').onclick = ()=> load(true);
             } else {
               more.innerHTML = `<span class="text-muted">Total ${rep.total} baris.</span>`;
             }
           })
           .withFailureHandler(err=> area.innerHTML = `<div class="alert alert-danger">${String(err)}</div>`)
           .getDataBulananPaged({ bulan, tahun, kelas, nisn, offset: nextOffset, maxRows: 200 }, TOKEN);
       }

       // autoload
       load(false);
     };

     // PELANGGARAN (PDF & WA)
     Initializers.Pelanggaran = function(){
       const area = document.getElementById('pl-wrap');
       const elBln= document.getElementById('pl-bulan');
       const elThn= document.getElementById('pl-tahun');
       const elKls= document.getElementById('pl-kelas');
       const now = new Date();
       elBln.value = now.getMonth()+1;
       elThn.value = now.getFullYear();

       google.script.run.withSuccessHandler(arr=>{
         elKls.innerHTML=''; elKls.add(new Option('Semua','Semua'));
         (arr||[]).forEach(k=> elKls.add(new Option(k,k)));
         if (ROLE==='Wali Kelas' && KELAS) elKls.value = KELAS;
       }).getDaftarKelas(TOKEN);

       document.getElementById('pl-tampilkan').addEventListener('click', ()=>{
         const bulan = Number(elBln.value), tahun = Number(elThn.value);
         let kelas = elKls.value; if (ROLE==='Wali Kelas' && KELAS) kelas=KELAS;

         area.innerHTML = '<div class="alert alert-info">Memuat...</div>';
         google.script.run
           .withSuccessHandler(rep=>{
             const rows = rep.rows || [];
             const html = `
               <div class="table-responsive">
                 <table class="table table-bordered align-middle">
                   <thead class="table-light">
                     <tr><th>#</th><th>NISN</th><th>Nama</th><th>Kelas</th><th>Alfa(max)</th><th>Izin(max)</th><th>Sakit(max)</th><th>Aksi</th></tr>
                   </thead>
                   <tbody>
                     ${rows.length? rows.map((r,i)=>`
                       <tr>
                         <td>${i+1}</td>
                         <td>${r.nisn}</td>
                         <td>${r.nama}</td>
                         <td>${r.kelas}</td>
                         <td>${r.alfa}</td>
                         <td>${r.izin}</td>
                         <td>${r.sakit}</td>
                         <td class="d-flex gap-2 flex-wrap">
                           ${r.alfa>3 ? `<button class="btn btn-sm btn-outline-danger" data-action="pl-pdf" data-nisn="${r.nisn}" data-jenis="Alfa"  data-streak="${r.alfa}">PDF Alfa</button>`:''}
                           ${r.izin>5 ?  `<button class="btn btn-sm btn-outline-warning" data-action="pl-pdf" data-nisn="${r.nisn}" data-jenis="Izin"  data-streak="${r.izin}">PDF Izin</button>`:''}
                           ${r.sakit>4 ? `<button class="btn btn-sm btn-outline-info"    data-action="pl-pdf" data-nisn="${r.nisn}" data-jenis="Sakit" data-streak="${r.sakit}">PDF Sakit</button>`:''}
                           <button class="btn btn-sm btn-success" data-action="pl-wa" data-nisn="${r.nisn}" data-jenis="Alfa"  data-streak="${r.alfa}">WA Alfa</button>
                           <button class="btn btn-sm btn-success" data-action="pl-wa" data-nisn="${r.nisn}" data-jenis="Izin"  data-streak="${r.izin}">WA Izin</button>
                           <button class="btn btn-sm btn-success" data-action="pl-wa" data-nisn="${r.nisn}" data-jenis="Sakit" data-streak="${r.sakit}">WA Sakit</button>
                         </td>
                       </tr>`).join('') : `<tr><td colspan="8" class="text-center text-muted">Tidak ada data</td></tr>`}
                   </tbody>
                 </table>
               </div>`;
             area.innerHTML = html;

             area.onclick = function(e){
               const btn = e.target.closest('button[data-action]');
               if (!btn) return;
               const action = btn.getAttribute('data-action');
               const payload = {
                 bulan, tahun, kelas,
                 nisn: btn.getAttribute('data-nisn'),
                 jenis: btn.getAttribute('data-jenis'),
                 streak: Number(btn.getAttribute('data-streak')||0)
               };

               const old = btn.textContent;
               btn.disabled = true; btn.textContent = '...';

               if (action === 'pl-pdf') {
                 google.script.run
                   .withSuccessHandler(url=> { btn.disabled=false; btn.textContent=old; window.open(url,'_blank'); })
                   .withFailureHandler(err=> { btn.disabled=false; btn.textContent=old; alert(String(err)); })
                   .exportPelanggaranPDF(payload, TOKEN);
                 return;
               }

               if (action === 'pl-wa') {
                 // ambil no HP → kirim WA
                 google.script.run
                   .withSuccessHandler(nohp=>{
                     const pesan = `Yth. Orang Tua/Wali, siswa NISN ${payload.nisn} tercatat ${payload.jenis}.\nBulan ${payload.bulan}/${payload.tahun}, ${payload.jenis} berturut-turut: ${payload.streak} hari. Mohon konfirmasi.`;
                     google.script.run
                       .withSuccessHandler(msg=>{ btn.disabled=false; btn.textContent=old; alert('WA: '+msg); })
                       .withFailureHandler(err=> { btn.disabled=false; btn.textContent=old; alert(String(err)); })
                       .sendWhatsApp({ to: nohp, message: pesan }, TOKEN);
                   })
                   .withFailureHandler(err=> { btn.disabled=false; btn.textContent=old; alert(String(err)); })
                   .getHpByNisn(payload.nisn, TOKEN);
                 return;
               }
             };
           })
           .withFailureHandler(err=> area.innerHTML = `<div class="alert alert-danger">${String(err)}</div>`)
           .getLaporanPelanggaran({ bulan, tahun, kelas }, TOKEN);
       });
     };

     // PENGATURAN (loader/saver Doc ID + WA)
     Initializers.Pengaturan = function () {
       const load = (key, inputId) => {
         google.script.run.withSuccessHandler(v => {
           const el = document.getElementById(inputId);
           if (el) el.value = v || '';
         }).loadSetting(key);
       };

       load('TEMPLATE_LAP_HARIAN_DOC_ID',            'tpl-harian');
       load('TEMPLATE_LAP_BULANAN_REKAP_DOC_ID',     'tpl-bulanan-rekap');
       load('TEMPLATE_LAP_BULANAN_PERSISWA_DOC_ID',  'tpl-bulanan-persiswa');
       load('TEMPLATE_PELANGGARAN_ALFA_DOC_ID',      'tpl-alfa');
       load('TEMPLATE_PELANGGARAN_IZIN_DOC_ID',      'tpl-izin');
       load('TEMPLATE_PELANGGARAN_SAKIT_DOC_ID',     'tpl-sakit');
       load('WA_API_ENDPOINT', 'wa-endpoint');
       load('WA_API_TOKEN',    'wa-token');

       const bindSave = (btnId, inputId, key) => {
         const btn = document.getElementById(btnId);
         if (!btn) return;
         btn.addEventListener('click', ()=>{
           const v = (document.getElementById(inputId)?.value || '').trim();
           google.script.run.withSuccessHandler(()=>alert('Tersimpan')).saveSetting(key, v);
         });
       };

       bindSave('btn-save-tpl-harian','tpl-harian','TEMPLATE_LAP_HARIAN_DOC_ID');
       bindSave('btn-save-tpl-bul-rekap','tpl-bulanan-rekap','TEMPLATE_LAP_BULANAN_REKAP_DOC_ID');
       bindSave('btn-save-tpl-bul-persiswa','tpl-bulanan-persiswa','TEMPLATE_LAP_BULANAN_PERSISWA_DOC_ID');
       bindSave('btn-save-tpl-alfa','tpl-alfa','TEMPLATE_PELANGGARAN_ALFA_DOC_ID');
       bindSave('btn-save-tpl-izin','tpl-izin','TEMPLATE_PELANGGARAN_IZIN_DOC_ID');
       bindSave('btn-save-tpl-sakit','tpl-sakit','TEMPLATE_PELANGGARAN_SAKIT_DOC_ID');
       bindSave('btn-save-wa-endpoint','wa-endpoint','WA_API_ENDPOINT');
       bindSave('btn-save-wa-token','wa-token','WA_API_TOKEN');
     };

     // EDIT KEHADIRAN (TU)
     Initializers.EditKehadiran = function(){
       const area = document.getElementById('ek-wrap');
       const btnCari = document.getElementById('ek-cari');
       if (!area || !btnCari) {
         const pc = document.getElementById('page-content');
         if (pc) pc.insertAdjacentHTML('afterbegin',
           `<div class="alert alert-warning">Elemen Edit Kehadiran tidak lengkap. Pastikan EditKehadiran.html memiliki #ek-wrap dan tombol #ek-cari.</div>`);
         return;
       }
       google.script.run.withSuccessHandler(arr=>{
         const sel = document.getElementById('ek-kelas');
         if (!sel) return;
         sel.innerHTML=''; arr.forEach(k=> sel.add(new Option(k,k)));
       }).getDaftarKelas(TOKEN);

       let nextOffset = 0;
       function load(append){
         const kelas = (document.getElementById('ek-kelas')?.value||'').trim();
         if (!append){ area.innerHTML='<div class="alert alert-info">Memuat...</div>'; nextOffset=0; }
         google.script.run
           .withSuccessHandler(rep=>{
             if (!append){
               area.innerHTML = `
                 <div class="table-responsive">
                   <table class="table table-bordered align-middle">
                     <thead class="table-light">
                       <tr><th>#</th><th>Tanggal</th><th>NISN</th><th>Nama</th><th>Kelas</th><th>Status</th><th>Keterangan</th><th>Petugas</th><th>Aksi</th></tr>
                     </thead>
                     <tbody id="ek-tbody"></tbody>
                   </table>
                 </div>
                 <div id="ek-more" class="mt-2"></div>

                                 <div class="modal fade" id="ekModal" tabindex="-1">
                   <div class="modal-dialog">
                     <div class="modal-content">
                       <div class="modal-header"><h5 class="modal-title">Edit Kehadiran</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                       <div class="modal-body">
                         <input type="hidden" id="ek-id">
                         <div class="mb-2"><label class="form-label">Tanggal</label><input type="date" class="form-control" id="ek-tanggal"></div>
                         <div class="mb-2"><label class="form-label">Status</label>
                           <select id="ek-st" class="form-select"><option>Alfa</option><option>Izin</option><option>Sakit</option></select>
                         </div>
                         <div class="mb-2"><label class="form-label">Keterangan</label><textarea class="form-control" id="ek-ket" rows="2"></textarea></div>
                       </div>
                       <div class="modal-footer"><button class="btn btn-primary" id="ek-simpan">Simpan</button></div>
                     </div>
                   </div>
                 </div>`;
             }

             const tbody = document.getElementById('ek-tbody');
             rep.rows.forEach((r,i)=>{
               const tr = document.createElement('tr');
               tr.innerHTML = `
                 <td>${nextOffset + i + 1}</td>
                 <td>${r.tanggal}</td><td>${r.nisn}</td><td>${r.nama}</td><td>${r.kelas}</td><td>${r.status}</td><td>${r.keterangan}</td><td>${r.petugas}</td>
                 <td><button class="btn btn-sm btn-outline-secondary" data-action="ek-edit" data-id="${r.id}" data-tgl="${r.tanggal}" data-st="${r.status}" data-ket="${r.keterangan}">Edit</button></td>`;
               tbody.appendChild(tr);
             });

             tbody.onclick = function(e){
               const btn = e.target.closest('button[data-action="ek-edit"]');
               if (!btn) return;
               document.getElementById('ek-id').value = btn.getAttribute('data-id');
               document.getElementById('ek-tanggal').value = btn.getAttribute('data-tgl') || '';
               document.getElementById('ek-st').value = btn.getAttribute('data-st') || 'Alfa';
               document.getElementById('ek-ket').value = btn.getAttribute('data-ket') || '';
               const modal = new bootstrap.Modal(document.getElementById('ekModal'));
               modal.show();
             };

             const more = document.getElementById('ek-more');
             if (rep.truncated) {
               nextOffset = rep.nextOffset;
               more.innerHTML = `<button class="btn btn-outline-primary">Muat lagi (sisa ${rep.total - nextOffset})</button>`;
               more.querySelector('button').onclick = ()=> load(true);
             } else {
               more.innerHTML = `<span class="text-muted">Total ${rep.total} baris.</span>`;
             }
           })
           .withFailureHandler(err=> area.innerHTML = `<div class="alert alert-danger">${String(err)}</div>`)
           .getAbsensiPage({ kelas, offset: nextOffset, maxRows: 100 }, TOKEN);
       }
       btnCari.addEventListener('click', ()=> load(false));

       document.getElementById('ek-simpan').addEventListener('click', ()=>{
         const id  = document.getElementById('ek-id').value;
         const tgl = document.getElementById('ek-tanggal').value;
         const st  = document.getElementById('ek-st').value;
         const ket = document.getElementById('ek-ket').value;

         google.script.run
           .withSuccessHandler(msg=>{ alert(msg); const modalEl=document.getElementById('ekModal'); bootstrap.Modal.getInstance(modalEl).hide(); document.getElementById('ek-cari').click(); })
           .withFailureHandler(err=> alert(String(err)))
           .updateAbsensi({ id_absensi:id, tanggal:tgl, status:st, keterangan:ket }, TOKEN);
       });
     };

     // DATA SISWA (TU)
     Initializers.DataSiswa = function(){
       let nextOffset = 0, lastParams = null;
       const area = document.getElementById('ds-wrap');

       google.script.run.withSuccessHandler(arr=>{
         const sel = document.getElementById('ds-kelas');
         if (sel){
           sel.innerHTML = '<option value="">(Semua)</option>';
           (arr||[]).forEach(k=> sel.add(new Option(k,k)));
         }
       }).getDaftarKelas(TOKEN);

       function renderRows(rep){
         const tbody = document.getElementById('ds-tbody');
         rep.rows.forEach((r,i)=>{
           const tr=document.createElement('tr');
           tr.innerHTML = `<td>${nextOffset+i+1}</td><td>${r.nisn}</td><td>${r.nama}</td><td>${r.kelas}</td><td>${r.nohp}</td>
           <td class="d-flex gap-2">
             <button class="btn btn-sm btn-outline-secondary" data-action="ds-edit" data-nisn="${r.nisn}" data-nama="${r.nama}" data-kelas="${r.kelas}" data-alamat="${r.alamat}" data-nohp="${r.nohp}">Edit</button>
             <button class="btn btn-sm btn-outline-danger" data-action="ds-del" data-nisn="${r.nisn}">Hapus</button>
           </td>`;
           tbody.appendChild(tr);
         });
         const more = document.getElementById('ds-more');
         if (rep.truncated) {
           nextOffset = rep.nextOffset;
           more.innerHTML = `<button class="btn btn-outline-primary">Muat lagi (sisa ${rep.total - nextOffset})</button>`;
           more.querySelector('button').onclick = ()=> load(true);
         } else {
           more.innerHTML = `<span class="text-muted">Total ${rep.total} data.</span>`;
         }
       }

       function load(append){
         const kelas=(document.getElementById('ds-kelas')?.value||'').trim();
         const q    =(document.getElementById('ds-q')?.value||'').trim();
         if (!append){
           area.innerHTML = `
             <div class="mb-3 d-flex gap-2 flex-wrap">
               <select id="ds-kelas" class="form-select" style="max-width:200px;"></select>
               <input id="ds-q" class="form-control" placeholder="Cari NISN/Nama/NoHP..." style="max-width:240px;">
               <button id="ds-cari" class="btn btn-primary">Tampilkan</button>
               <button id="ds-tambah" class="btn btn-success">Tambah</button>
             </div>
             <div class="table-responsive">
               <table class="table table-bordered align-middle">
                 <thead class="table-light"><tr><th>#</th><th>NISN</th><th>Nama</th><th>Kelas</th><th>No HP</th><th>Aksi</th></tr></thead>
                 <tbody id="ds-tbody"></tbody>
               </table>
             </div>
             <div id="ds-more" class="mt-2"></div>

                         <div class="modal fade" id="dsModal" tabindex="-1">
               <div class="modal-dialog">
                 <div class="modal-content">
                   <div class="modal-header"><h5 class="modal-title">Data Siswa</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                   <div class="modal-body">
                     <input type="hidden" id="ds-original-nisn">
                     <div class="mb-2"><label class="form-label">NISN</label><input id="ds-nisn" class="form-control" placeholder="angka"></div>
                     <div class="mb-2"><label class="form-label">Nama</label><input id="ds-nama" class="form-control"></div>
                     <div class="mb-2"><label class="form-label">Kelas</label><select id="ds-kelas-form" class="form-select"></select></div>
                     <div class="mb-2"><label class="form-label">Alamat</label><input id="ds-alamat" class="form-control"></div>
                     <div class="mb-2"><label class="form-label">No HP</label><input id="ds-hp" class="form-control"></div>
                   </div>
             _ ... (rest of the code is unchanged) ... _
                 <div class="modal-footer"><button class="btn btn-primary" id="ds-simpan">Simpan</button></div>
                 </div>
               </div>
             </div>`;
         }

         // isi kelas filter & form
         google.script.run.withSuccessHandler(arr=>{
           const selF=document.getElementById('ds-kelas');
           const selForm=document.getElementById('ds-kelas-form');
           if (selF && !append){
             selF.innerHTML='<option value="">(Semua)</option>'; (arr||[]).forEach(k=> selF.add(new Option(k,k)));
           }
           if (selForm){
             selForm.innerHTML=''; (arr||[]).forEach(k=> selForm.add(new Option(k,k)));
           }
         }).getDaftarKelas(TOKEN);

         google.script.run.withSuccessHandler(rep=>{
           if (!append) document.getElementById('ds-tbody').innerHTML='';
           renderRows(rep);
           // events
           if (!append){
             document.getElementById('ds-cari').onclick = ()=>{ nextOffset=0; lastParams=null; load(false); };
             document.getElementById('ds-tambah').onclick = ()=>{
               document.getElementById('ds-original-nisn').value = '';
               document.getElementById('ds-nisn').value='';
               document.getElementById('ds-nama').value='';
               document.getElementById('ds-kelas-form').selectedIndex=0;
               document.getElementById('ds-alamat').value='';
               document.getElementById('ds-hp').value='';
               new bootstrap.Modal(document.getElementById('dsModal')).show();
             };

             document.getElementById('ds-tbody').onclick = function(e){
               const btnEdit = e.target.closest('button[data-action="ds-edit"]');
               const btnDel  = e.target.closest('button[data-action="ds-del"]');
               if (btnEdit){
                 document.getElementById('ds-original-nisn').value = btnEdit.getAttribute('data-nisn');
                 document.getElementById('ds-nisn').value   = btnEdit.getAttribute('data-nisn');
                 document.getElementById('ds-nama').value   = btnEdit.getAttribute('data-nama');
                 document.getElementById('ds-kelas-form').value = btnEdit.getAttribute('data-kelas');
                 document.getElementById('ds-alamat').value = btnEdit.getAttribute('data-alamat')||'';
                 document.getElementById('ds-hp').value     = btnEdit.getAttribute('data-nohp')||'';
                 new bootstrap.Modal(document.getElementById('dsModal')).show();
               }
               if (btnDel){
                 const nisn = btnDel.getAttribute('data-nisn');
                 if (!confirm(`Hapus siswa NISN ${nisn}?`)) return;
                 google.script.run
                   .withSuccessHandler(msg=>{ alert(msg); nextOffset=0; lastParams=null; load(false); })
                   .withFailureHandler(err=>{
                     const s=String(err);
                     if (s.includes('Gunakan hapus dengan konfirmasi (force)')){
                       if (confirm('Siswa memiliki data Absensi. Tetap hapus? (Data absensi tidak dihapus)')){
                         google.script.run
                           .withSuccessHandler(msg2=>{ alert(msg2); nextOffset=0; lastParams=null; load(false); })
                           .withFailureHandler(err2=> alert(String(err2)))
                           .deleteSiswaByNisn(nisn, true, TOKEN);
                       }
                     } else { alert(s); }
                   })
                   .deleteSiswaByNisn(nisn, false, TOKEN);
               }
             };

             const btnSave = document.getElementById('ds-simpan');
             if (btnSave) btnSave.addEventListener('click', ()=>{
               const originalNisn = document.getElementById('ds-original-nisn').value || '';
               const nisn  = (document.getElementById('ds-nisn').value || '').trim();
               const nama  = (document.getElementById('ds-nama').value || '').trim();
               const kelas = (document.getElementById('ds-kelas-form').value || '').trim();
               const alamat= (document.getElementById('ds-alamat').value || '').trim();
               const nohp  = (document.getElementById('ds-hp').value || '').trim();

               if (!nisn || !/^\d+$/.test(nisn)) return alert('NISN wajib angka.');
               if (!nama) return alert('Nama wajib diisi.');
               if (!kelas) return alert('Kelas wajib dipilih.');

               btnSave.disabled = true; btnSave.textContent='Menyimpan...';
               google.script.run
                 .withSuccessHandler(msg=>{
                   btnSave.disabled=false; btnSave.textContent='Simpan';
                   bootstrap.Modal.getInstance(document.getElementById('dsModal')).hide();
                   nextOffset=0; lastParams=null; load(false);
                   alert(msg);
                 })
                 .withFailureHandler(err=>{ btnSave.disabled=false; btnSave.textContent='Simpan'; alert(String(err)); })
                 .upsertSiswa({ originalNisn, nisn, nama, kelas, alamat, nohp }, TOKEN);
             });
           }
         }).getSiswaPage({ kelas, q, offset: nextOffset, maxRows: 100 }, TOKEN);
       }

       // auto load
       load(false);
     };

  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
